{% import 'image.html' as image %}
{% extends "layout.html" %}
{% block body %}
{% if current_user.show_detail_random() and page != "discover" %}
<div class="discover random-books">
  <h2 class="random-books">{{_('Discover (Random Books)')}}</h2>
  <div class="row">
    {% for entry in random %}
    <div class="col-sm-3 col-lg-2 col-xs-6 book session" id="books_rand">
      <div class="cover">
        <a href="{{ url_for('web.show_book', book_id=entry.Books.id) }}" target="_blank">
          <span class="img" title="{{ entry.Books.title }}">
            {{ image.book_cover(entry.Books) }}
            {% if entry[2] == True %}<span class="badge read glyphicon glyphicon-ok"></span>{% endif %}
          </span>
        </a>
      </div>
      <div class="meta">
        <a href="{{ url_for('web.show_book', book_id=entry.Books.id) }}" target="_blank">
          <p title="{{entry.Books.title}}" class="title">{{entry.Books.title|shortentitle}}</p>
        </a>
        <p class="author">
          {% for author in entry.Books.authors %}
          {% if loop.index > g.config_authors_max and g.config_authors_max != 0 %}
          {% if not loop.first %}
          <span class="author-hidden-divider">&amp;</span>
          {% endif %}
          <a class="author-name author-hidden"
            href="{{url_for('web.books_list', data='author', sort_param='stored', book_id=author.id) }}">{{author.name.replace('|',',')|shortentitle(30)}}</a>
          {% if loop.last %}
          <a href="#" class="author-expand" data-authors-max="{{g.config_authors_max}}"
            data-collapse-caption="({{_('reduce')}})">(...)</a>
          {% endif %}
          {% else %}
          {% if not loop.first %}
          <span>&amp;</span>
          {% endif %}
          <a class="author-name"
            href="{{url_for('web.books_list',  data='author', sort_param='stored', book_id=author.id) }}">{{author.name.replace('|',',')|shortentitle(30)}}</a>
          {% endif %}
          {% endfor %}
        </p>
        {% if entry.Books.series.__len__() > 0 %}
        <p class="series">
          <a
            href="{{url_for('web.books_list', data='series', sort_param='stored', book_id=entry.Books.series[0].id )}}">
            {{entry.Books.series[0].name}}
          </a>
          ({{entry.Books.series_index|formatfloat(2)}})
        </p>
        {% endif %}
        {% if entry.Books.ratings.__len__() > 0 %}
        <div class="rating">
          {% for number in range((entry.Books.ratings[0].rating/2)|int(2)) %}
          <span class="glyphicon glyphicon-star good"></span>
          {% if loop.last and loop.index < 5 %} {% for numer in range(5 - loop.index) %} <span
            class="glyphicon glyphicon-star-empty"></span>
            {% endfor %}
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}
<div class="discover load-more">
  <h2 class="{{title}}">{{title}}</h2>
  {% if page != 'discover' %}
  <div class="filterheader hidden-xs">
    {% if page == 'hot' %}
    <a data-toggle="tooltip" title="{{_('Sort ascending according to download count')}}" id="hot_asc"
      class="btn btn-primary{% if order == " hotasc" %} active{% endif%}"
      href="{{url_for('web.books_list', data=page, book_id=id, sort_param='hotasc')}}"><span
        class="glyphicon glyphicon-sort-by-order"></span></a>
    <a data-toggle="tooltip" title="{{_('Sort descending according to download count')}}" id="hot_desc"
      class="btn btn-primary{% if order == " hotdesc" %} active{% endif%}"
      href="{{url_for('web.books_list', data=page, book_id=id, sort_param='hotdesc')}}"><span
        class="glyphicon glyphicon-sort-by-order-alt"></span></a>
    {% else %}
    <a data-toggle="tooltip" title="{{_('Sort according to added date, newest first')}}" id="new"
      class="btn btn-primary{% if order == " new" %} active{% endif%}"
      href="{{url_for('web.books_list', data=page, book_id=id, sort_param='new')}}"><span
        class="glyphicon glyphicon-book"></span> <span class="glyphicon glyphicon-calendar"></span><span
        class="glyphicon glyphicon-sort-by-order"></span></a>
    <a data-toggle="tooltip" title="{{_('Sort according to added date, oldest first')}}" id="old"
      class="btn btn-primary{% if order == " old" %} active{% endif%}"
      href="{{url_for('web.books_list', data=page, book_id=id, sort_param='old')}}"><span
        class="glyphicon glyphicon-book"></span> <span class="glyphicon glyphicon-calendar"></span><span
        class="glyphicon glyphicon-sort-by-order-alt"></span></a>
    <a data-toggle="tooltip" title="{{_('Sort title in alphabetical order')}}" id="asc"
      class="btn btn-primary{% if order == " abc" %} active{% endif%}"
      href="{{url_for('web.books_list', data=page, book_id=id, sort_param='abc')}}"><span
        class="glyphicon glyphicon-font"></span><span class="glyphicon glyphicon-sort-by-alphabet"></span></a>
    <a data-toggle="tooltip" title="{{_('Sort title in reverse alphabetical order')}}" id="desc"
      class="btn btn-primary{% if order == " zyx" %} active{% endif%}"
      href="{{url_for('web.books_list', data=page, book_id=id, sort_param='zyx')}}"><span
        class="glyphicon glyphicon-font"></span><span class="glyphicon glyphicon-sort-by-alphabet-alt"></span></a>
    <a data-toggle="tooltip" title="{{_('Sort authors in alphabetical order')}}" id="auth_az"
      class="btn btn-primary{% if order == " authaz" %} active{% endif%}"
      href="{{url_for('web.books_list', data=page, book_id=id, sort_param='authaz')}}"><span
        class="glyphicon glyphicon-user"></span><span class="glyphicon glyphicon-sort-by-alphabet"></span></a>
    <a data-toggle="tooltip" title="{{_('Sort authors in reverse alphabetical order')}}" id="auth_za"
      class="btn btn-primary{% if order == " authza" %} active{% endif%}"
      href="{{url_for('web.books_list', data=page, book_id=id, sort_param='authza')}}"><span
        class="glyphicon glyphicon-user"></span><span class="glyphicon glyphicon-sort-by-alphabet-alt"></span></a>
    <a data-toggle="tooltip" title="{{_('Sort according to publishing date, newest first')}}" id="pub_new"
      class="btn btn-primary{% if order == " pubnew" %} active{% endif%}"
      href="{{url_for('web.books_list', data=page, book_id=id, sort_param='pubnew')}}"><span
        class="glyphicon glyphicon-calendar"></span><span class="glyphicon glyphicon-sort-by-order"></span></a>
    <a data-toggle="tooltip" title="{{_('Sort according to publishing date, oldest first')}}" id="pub_old"
      class="btn btn-primary{% if order == " pubold" %} active{% endif%}"
      href="{{url_for('web.books_list', data=page, book_id=id, sort_param='pubold')}}"><span
        class="glyphicon glyphicon-calendar"></span><span class="glyphicon glyphicon-sort-by-order-alt"></span></a>
    {% if page == 'series' %}
    <a data-toggle="tooltip" title="{{_('Sort ascending according to series index')}}" id="series_asc"
      class="btn btn-primary{% if order == " seriesasc" %} active{% endif%}"
      href="{{url_for('web.books_list', data=page, book_id=id, sort_param='seriesasc')}}"><span
        class="glyphicon glyphicon-sort-by-order"></span></a>
    <a data-toggle="tooltip" title="{{_('Sort descending according to series index')}}" id="series_desc"
      class="btn btn-primary{% if order == " seriesdesc" %} active{% endif%}"
      href="{{url_for('web.books_list', data=page, book_id=id, sort_param='seriesdesc')}}"><span
        class="glyphicon glyphicon-sort-by-order-alt"></span></a>
    {% endif %}
    {% endif %}
    <div class="view-toggle btn-group pull-right" style="margin-left: 10px;">
      <button class="btn btn-primary active" title="{{_('Grid View')}}"><span
          class="glyphicon glyphicon-th"></span></button>
      <button class="btn btn-primary toggle-view" data-view="table" title="{{_('Table View')}}"><span
          class="glyphicon glyphicon-list"></span></button>
    </div>
  </div>
  {% endif %}
  <div class="row display-flex" style="display: flex; flex-wrap: wrap; margin-right: -15px; margin-left: -15px;">
    {% if entries[0] %}
    {% for entry in entries %}
    {% set book = entry.Books if entry.Books is defined else (entry[0] if entry is sequence and entry is not string else
    entry) %}
    <div class="col-sm-3 col-lg-2 col-xs-6 book session" id="books" style="float: none;" {% if book.series
      %}data-series-id="{{book.series[0].id}}" {% endif %}>
      <div class="cover">
        <a href="{{ url_for('web.show_book', book_id=book.id) }}" target="_blank">
          <span class="img" title="{{ book.title }}">
            {{ image.book_cover(book) }}
            {% if entry[2] == True %}<span class="badge read glyphicon glyphicon-ok"></span>{% endif %}
          </span>
        </a>
      </div>
      <div class="user-pref-container" style="text-align: center; margin-top: 5px; height: 30px;">
        {% if pref_book_ids is defined and book.__tablename__ == 'books' %}
        <span
          class="glyphicon glyphicon-heart prefer-btn {% if pref_book_ids.get(book.id) == 1 %}active-pref{% endif %}"
          data-id="{{book.id}}" data-type="0" title="{{ _('Prefer Book') }}"
          style="font-size: 20px; cursor: pointer; margin-right: 10px;"></span>
        <span
          class="glyphicon glyphicon-ban-circle ignore-btn {% if pref_book_ids.get(book.id) == -1 %}active-pref{% endif %}"
          data-id="{{book.id}}" data-type="0" title="{{ _('Ignore Book') }}"
          style="font-size: 20px; cursor: pointer;"></span>
        {% elif page == 'series' and pref_series_ids is defined and book.series %}
        <span
          class="glyphicon glyphicon-heart prefer-btn {% if pref_series_ids.get(book.series[0].id) == 1 %}active-pref{% endif %}"
          data-id="{{book.series[0].id}}" data-type="1" title="{{ _('Prefer Series') }}"
          style="font-size: 20px; cursor: pointer; margin-right: 10px;"></span>
        <span
          class="glyphicon glyphicon-ban-circle ignore-btn {% if pref_series_ids.get(book.series[0].id) == -1 %}active-pref{% endif %}"
          data-id="{{book.series[0].id}}" data-type="1" title="{{ _('Ignore Series') }}"
          style="font-size: 20px; cursor: pointer;"></span>
        {% elif page == 'author' and pref_author_ids is defined and book.authors %}
        <span
          class="glyphicon glyphicon-heart prefer-btn {% if pref_author_ids.get(book.authors[0].id) == 1 %}active-pref{% endif %}"
          data-id="{{book.authors[0].id}}" data-type="2" title="{{ _('Prefer Author') }}"
          style="font-size: 20px; cursor: pointer; margin-right: 10px;"></span>
        <span
          class="glyphicon glyphicon-ban-circle ignore-btn {% if pref_author_ids.get(book.authors[0].id) == -1 %}active-pref{% endif %}"
          data-id="{{book.authors[0].id}}" data-type="2" title="{{ _('Ignore Author') }}"
          style="font-size: 20px; cursor: pointer;"></span>
        {% endif %}
      </div>
      <div class="meta">
        <a href="{{ url_for('web.show_book', book_id=book.id) }}" target="_blank">
          <p title="{{ book.title }}" class="title">{{book.title|shortentitle}}</p>
        </a>
        <p class="author">
          {% for author in book.authors %}
          {% if loop.index > g.config_authors_max and g.config_authors_max != 0 %}
          {% if not loop.first %}
          <span class="author-hidden-divider">&amp;</span>
          {% endif %}
          <a class="author-name author-hidden"
            href="{{url_for('web.books_list', data='author', book_id=author.id, sort_param='stored') }}">{{author.name.replace('|',',')|shortentitle(30)}}</a>
          {% if loop.last %}
          <a href="#" class="author-expand" data-authors-max="{{g.config_authors_max}}"
            data-collapse-caption="({{_('reduce')}})">(...)</a>
          {% endif %}
          {% else %}
          {% if not loop.first %}
          <span>&amp;</span>
          {% endif %}
          <a class="author-name"
            href="{{url_for('web.books_list', data='author', book_id=author.id, sort_param='stored') }}">{{author.name.replace('|',',')|shortentitle(30)}}</a>
          {% endif %}
          {% endfor %}
          {% if entry.Books.data|music %}
          <span class="glyphicon glyphicon-music"></span>
          {% endif %}
        </p>
        {% if entry.Books.series.__len__() > 0 %}
        <p class="series">
          {% if page != "series" %}
          <a
            href="{{url_for('web.books_list', data='series', sort_param='stored', book_id=entry.Books.series[0].id )}}">
            {{entry.Books.series[0].name}}
          </a>
          {% else %}
          <span>{{entry.Books.series[0].name}}</span>
          {% endif %}
          ({{entry.Books.series_index|formatfloat(2)}})
        </p>
        {% endif %}
        {% if entry.Books.ratings.__len__() > 0 %}
        <div class="rating">
          {% for number in range((entry.Books.ratings[0].rating/2)|int(2)) %}
          <span class="glyphicon glyphicon-star good"></span>
          {% if loop.last and loop.index < 5 %} {% for numer in range(5 - loop.index) %} <span
            class="glyphicon glyphicon-star-empty"></span>
            {% endfor %}
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
    {% endif %}
  </div>

  {% if page == "series" and missing_series_books %}
  <div class="missing-series-books"
    style="margin-top: 40px; border-top: 1px solid #444; padding-top: 30px; margin-bottom: 50px;">
    <h3><span class="glyphicon glyphicon-exclamation-sign text-warning"></span> {{_('Incomplete Collection: Potential
      Missing Installments')}}</h3>
    <p class="text-muted" style="margin-bottom: 20px;">{{_('Based on external bibliographies, these books appear to
      belong to this series but are not in your library:')}}</p>
    <div class="row display-flex" style="display: flex; flex-wrap: wrap; margin-right: -15px; margin-left: -15px;">
      {% for missing_title in missing_series_books %}
      <div class="col-sm-3 col-lg-2 col-xs-6 book" style="opacity: 0.8; margin-bottom: 25px;">
        <div class="cover"
          style="filter: grayscale(100%); border: 2px dashed #555; border-radius: 4px; display: flex; align-items: center; justify-content: center; aspect-ratio: 2/3; background: #2a2a2a; transition: all 0.3s;">
          <div style="text-align: center; color: #777; padding: 10px;">
            <span class="glyphicon glyphicon-book" style="font-size: 40px; display: block; margin-bottom: 10px;"></span>
            <span style="font-size: 12px; font-weight: bold; text-transform: uppercase;">{{_('Missing')}}</span>
          </div>
        </div>
        <div class="meta" style="margin-top: 10px;">
          <p class="title" title="{{missing_title}}"
            style="font-style: italic; color: #bbb; line-height: 1.2; height: 2.4em; overflow: hidden;">
            {{missing_title|shortentitle}}</p>
          <a href="https://openlibrary.org/search?q={{missing_title|urlencode}}" target="_blank"
            class="btn btn-xs btn-default"
            style="margin-top: 8px; width: 100%; border-color: #444; background: transparent; color: #aaa;">
            <span class="glyphicon glyphicon-info-sign"></span> {{_('Search Info')}}
          </a>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block js %}
<script>
  // Smart List: Collapse Series items in Grid
  $(document).ready(function () {
    if ('{{page}}' !== 'series' && '{{page}}' !== 'author') {
      console.log("Smart List Active for page: {{page}}");
      var seriesGroups = {};
      $('.book[data-series-id]').each(function () {
        var sid = $(this).attr('data-series-id');
        if (sid) {
          if (!seriesGroups[sid]) seriesGroups[sid] = [];
          seriesGroups[sid].push($(this));
        }
      });

      $.each(seriesGroups, function (sid, rows) {
        if (rows.length > 1) {
          var $first = rows[0];
          var $toggle = $('<div class="series-toggle badge" style="position:absolute; top:-10px; right:-10px; cursor:pointer; background:#2c3e50; z-index:10;" title="{{_("Toggle Series")}}">+' + (rows.length - 1) + '</div>');

          $first.css('position', 'relative').append($toggle);
          $first.css('box-shadow', '5px 5px 0px #888');

          // Create a container for hidden items inside the first book element or body
          var $hiddenContainer = $('<div class="series-popup-' + sid + '" style="display:none; position:absolute; z-index:9999; background:#222; border:1px solid #444; padding:15px; width:300px; max-height:400px; overflow-y:auto; border-radius:4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);"></div>');
          $('body').append($hiddenContainer);

          for (var i = 1; i < rows.length; i++) {
            // DETACH from grid and APPEND to popup container
            // We restore the 'col' classes visually inside the popup but as block elements (width 100%) or grid
            var $book = $(rows[i]);
            $book.removeClass('col-sm-3 col-lg-2 col-xs-6 book session').addClass('series-child-' + sid).css({ 'float': 'none', 'width': '100%', 'height': 'auto', 'min-height': '0', 'margin-bottom': '10px', 'display': 'flex', 'flex-direction': 'row' });
            // Adjust internal layout for list view style inside popup
            $book.find('.cover').css({ 'width': '60px', 'height': 'auto', 'margin-right': '10px' });
            $book.find('.cover img').css({ 'max-height': '90px', 'width': 'auto' });
            $book.find('.meta').css({ 'text-align': 'left', 'margin-top': '0' });

            $book.appendTo($hiddenContainer);
          }

          $toggle.click(function (e) {
            e.preventDefault();
            e.stopPropagation();

            var $popup = $('.series-popup-' + sid);

            // Positioning logic
            var offset = $first.offset();
            $popup.css({
              top: offset.top + 20,
              left: offset.left + 20
            });

            // Close other popups
            $('.series-popup').not($popup).hide();

            $popup.toggle();

            // Close on click outside
            $(document).one('click', function () {
              $popup.hide();
            });
          });

          // Prevent closing when clicking inside popup
          $hiddenContainer.click(function (e) {
            e.stopPropagation();
          });
        }
      });
    }

    // Show prefs on hover
    $('.cover').hover(function () {
      $(this).find('.user-pref-overlay').show();
    }, function () {
      $(this).find('.user-pref-overlay').hide();
    });

    // View Toggle Handler
    $('.toggle-view').click(function () {
      var view = $(this).data('view');
      var page = '{{page}}';
      $.ajax({
        url: "{{ url_for('web.update_view') }}",
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ [page]: { view_type: view } }),
        success: function () {
          location.reload();
        }
      });
    });
  });
</script>
{% endblock %}