{% extends "layout.html" %}
{% block body %}
<div class="discover">
    <h2>{{_('Blocked & Rejected Access IDs')}}</h2>

    {% if rejected_list|length == 0 %}
    <div class="alert alert-info">
        <p>{{_('No blocked or rejected access records.')}}</p>
    </div>
    {% else %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>{{_('Username')}}</th>
                    <th>{{_('phpBB ID')}}</th>
                    <th>{{_('Rejections')}}</th>
                    <th>{{_('Last Rejection')}}</th>
                    <th>{{_('Reason')}}</th>
                    <th>{{_('Status')}}</th>
                    <th>{{_('Actions')}}</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in rejected_list %}
                <tr id="rejected-row-{{ entry.id }}">
                    <td>{{ entry.username }}</td>
                    <td>{{ entry.phpbb_user_id }}</td>
                    <td>
                        <span class="badge badge-{% if entry.rejection_count >= 3 %}danger{% else %}warning{% endif %}">
                            {{ entry.rejection_count }}
                        </span>
                    </td>
                    <td>{{ entry.last_rejection_at.strftime('%Y-%m-%d %H:%M') if entry.last_rejection_at else '' }}</td>
                    <td>
                        {% if entry.rejection_reason %}
                        <span class="text-muted" title="{{ entry.rejection_reason }}">
                            {{ entry.rejection_reason[:50] }}{% if entry.rejection_reason|length > 50 %}...{% endif %}
                        </span>
                        {% else %}
                        <span class="text-muted">{{_('N/A')}}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if entry.blocked %}
                        <span class="label label-danger">{{_('BLOCKED')}}</span>
                        {% else %}
                        <span class="label label-warning">{{_('Cooldown')}}</span>
                        {% endif %}
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary"
                            onclick="unblockId({{ entry.id }}, '{{ entry.username }}')"
                            title="{{_('Reset and allow new requests')}}">
                            <span class="glyphicon glyphicon-refresh"></span> {{_('Reset')}}
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <a href="{{ url_for('admin.admin') }}" class="btn btn-default">{{_('Back to Admin')}}</a>
</div>

<script>
    function unblockId(rejectedId, username) {
        if (!confirm('{{_("Reset rejection history for")}} ' + username + '? {{_("They will be able to request access again.")}}')) {
            return;
        }

        $.post('{{ url_for("admin.unblock_access_id") }}', {
            rejected_id: rejectedId,
            csrf_token: '{{ csrf_token() }}'
        }).done(function (data) {
            if (data.success) {
                $('#rejected-row-' + rejectedId).fadeOut(400, function () {
                    $(this).remove();
                    if ($('tbody tr').length === 0) {
                        location.reload();
                    }
                });
                toastr.success('{{_("ID unblocked successfully")}}');
            } else {
                toastr.error(data.message || '{{_("Failed to unblock ID")}}');
            }
        }).fail(function () {
            toastr.error('{{_("Network error")}}');
        });
    }
</script>
{% endblock %}